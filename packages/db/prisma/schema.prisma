generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified Boolean?
  image         String?
  imagePublicId String?
  password      String?
  isSubscribed  Boolean   @default(false)
  isDeleted     Boolean   @default(false)
  bio           String?
  createdAt     DateTime? @default(now())
  updatedAt     DateTime? @updatedAt

  accounts       Account[]
  interviews     Interview[]
  payment        Payment[]
  Resume         Resume[]
  userActivities UserActivity[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id])

  @@unique([provider, providerAccountId])
}

enum InterviewStatus {
  PENDING
  COMPLETED
  INCOMPLETE
  ERROR
}

model Interview {
  interviewId         String            @id @default(cuid())
  userId              String
  user                User              @relation(fields: [userId], references: [id]) // changed to reference id
  role                String?
  level               String?
  transcribe          Json?
  noOfQuestions       Int
  type                String?
  status              InterviewStatus   @default(PENDING)
  updatedAt           DateTime          @updatedAt
  createdAt           DateTime          @default(now())
  isDeleted           Boolean           @default(false)

  interviewTemplateId  String?
  template             InterviewTemplate? @relation(fields: [interviewTemplateId], references: [interviewTemplateId])

  questions Question[]
  feedback  Feedback?
  audio     InterviewAudio?
}

model Question {
  questionId  String    @id @default(uuid())
  interviewId String
  interview   Interview @relation(fields: [interviewId], references: [interviewId])

  questionText String
  AIanswer  String?
  order        Int
  createdAt    DateTime @default(now())
}

model Feedback {
  feedbackId  String    @id @default(uuid())
  interviewId String    @unique
  interview   Interview @relation(fields: [interviewId], references: [interviewId])

  overallScore     Int
  summary          String
  keyStrengths     String[]
  improvementAreas String[]

  communicationScore  Int
  technicalScore      Int
  problemSolvingScore Int
  behavioralScore     Int
  confidenceScore     Int

  fullFeedbackJson Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model InterviewAudio {
  audioId     String    @id @default(uuid())
  interviewId String    @unique
  interview   Interview @relation(fields: [interviewId], references: [interviewId])

  isDeleted  Boolean  @default(false)
  startTime  DateTime
  endTime    DateTime
  transcript String[]
  audioUrl   String
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

model Payment {
  paymentId         String   @id @default(uuid())
  createdAt         DateTime @default(now())

  userId            String
  user              User     @relation(fields: [userId], references: [id])

  amount            Int
  currency          String   @default("INR")
  paymentMethod     String?

  status            PaymentStatus @default(PENDING)

  dodoOrderId       String?  @unique
  dodoPaymentId     String?  @unique
  dodoSignature     String?

  metadata          Json?

  @@index([userId])
}


model Resume {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  fileName       String
  isDeleted      Boolean         @default(false)
  publicId       String
  fileUrl        String
  QdrantStatus   String          @default("uploadeding")
  AnalysisStatus String          @default("pending")
  qdrantFileId   String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  ResumeAnalysis ResumeAnalysis?
}

model ResumeAnalysis {
  resumeAnalysisId String   @id @default(cuid())
  resumeId         String   @unique
  resume           Resume   @relation(fields: [resumeId], references: [id], onDelete: Cascade)
  atsScore         Int?
  analysis         Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

enum ActivityAction {
  // User Actions
  PASSWORD_RESET_REQUEST

  // Interview Actions
  INTERVIEW_COMPLETED
  INTERVIEW_DELETED

  // Resume Actions
  RESUME_UPLOADED
  RESUME_DELETED

  // Payment/Subscription Actions
  SUBSCRIPTION_STARTED
  PAYMENT_SUCCESS
  PAYMENT_FAILED

  // Admin Actions
  ADMIN_LOGIN
  ADMIN_TEMPLATE_CREATED
  ADMIN_USER_DELETED
}

enum ActivityTarget {
  USER
  INTERVIEW
  RESUME
  PAYMENT
  INTERVIEW_TEMPLATE
  ADMIN
  // Add other models as needed
}

model UserActivity {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  adminId String?
  admin   Admin?  @relation(fields: [adminId], references: [id], onDelete: SetNull)

  action ActivityAction

  targetType ActivityTarget
  targetId   String

  details String?

  @@index([userId])
  @@index([adminId])
  @@index([targetType, targetId]) // Useful for finding all activity for a specific resume
}

// LEVEL 1: Your main categories like Tech, Sales, Marketing.
model MainCategory {
  mainCategoryId String @id @default(cuid())
  name           String @unique // "Tech", "Sales", etc.

  subCategories SubCategory[]
}

model SubCategory {
  subCategoryId String @id @default(cuid())
  name          String // "Frontend", "Backend", "Lead Generation"

  mainCategoryId String
  mainCategory   MainCategory @relation(fields: [mainCategoryId], references: [mainCategoryId])

  templates InterviewTemplate[]

  @@unique([name, mainCategoryId])
}

model InterviewTemplate {
  interviewTemplateId String  @id @default(cuid())
  title               String
  description         String?
  estimatedDuration   Int

  subCategoryId String
  subCategory   SubCategory @relation(fields: [subCategoryId], references: [subCategoryId])

  tags      Tag[]
  Interview Interview[]
}

model Tag {
  TagId String @id @default(cuid())
  name  String @unique

  templates InterviewTemplate[]
}

enum AdminRoleType {
  SUPER_ADMIN
  MANAGER
  SUPPORT
}

model Admin {
  id             String         @id @default(cuid())
  name           String
  email          String         @unique
  password       String
  expiresAt      DateTime?
  role           AdminRoleType  @default(MANAGER)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  userActivities UserActivity[]
}
